.docker_image_builder_job:
  variables:
    FF_NETWORK_PER_BUILD: "true"

    # uses registry.gitlab.syncad.com/hive/hive/custom_docker:20.10.10
    DOCKER_IMAGE_TAG: "@sha256:1962f1ef35c1f1620269306cd735923993ad8546566cad86f133abccf314cc56"

  image: "registry.gitlab.syncad.com/hive/hive/custom_docker${DOCKER_IMAGE_TAG}"
  interruptible: true
  services:
    - name: "registry.gitlab.syncad.com/hive/hive/custom_dind:20.10.10-dind-1"
      alias: "docker"
      pull_policy: [always, if-not-present]
      variables:
        DOCKER_BUILDKIT: 1
        DOCKER_DRIVER: "overlay2"
        DOCKER_TLS_CERTDIR: "/certs"

.docker_image_cleanup_job:
  image: alpine:3.16
  interruptible: true
  before_script:
    - apk update && apk add bash curl jq

  variables:
    # Interface variables (to be overrided by derived jobs)
    REGISTRY: $CI_REGISTRY_IMAGE
    REGISTRY_USER: ""
    REGISTRY_PASS: ""
    IMAGE_PATH: ""
    IMAGE_TAG: ""

    SCRIPTS_PATH: "$CI_PROJECT_DIR/scripts"

  script:
    - echo "Attempting to cleanup an image $IMAGE_PATH using tag $IMAGE_TAG from $REGISTRY"
    - "$SCRIPTS_PATH/ci-helpers/delete-image.sh"

  when: always

.prepare_hived_data_5m_image:
  extends: .docker_image_builder_job

  variables:
    SUBMODULE_DIR: "$CI_PROJECT_DIR"
    REGISTRY_USER: "$CI_IMG_BUILDER_USER"
    REGISTRY_PASS: $CI_IMG_BUILDER_PASSWORD

    SCRIPTS_PATH: "$SUBMODULE_DIR/scripts"
  script:
    - $SCRIPTS_PATH/ci-helpers/get_image4submodule.sh "$SUBMODULE_DIR" registry.gitlab.syncad.com/hive/hive/ "HIVED_IMAGE_NAME" "$REGISTRY_USER" "$REGISTRY_PASS" "hived-mainnet-binaries"
    - ls -la ./hived-mainnet-binaries/*

  artifacts:
    reports:
      dotenv: docker_image_name.env
    paths:
      - ./hived-mainnet-binaries/*
    expire_in: 6 hours

.prepare_hived_image:
  extends: .docker_image_builder_job

  variables:
    SUBMODULE_DIR: "$CI_PROJECT_DIR"
    SCRIPTS_PATH: "$SUBMODULE_DIR/scripts"
    REGISTRY_USER: "$CI_IMG_BUILDER_USER"
    REGISTRY_PASS: $CI_IMG_BUILDER_PASSWORD
    BINARY_CACHE_PATH: "hived-mainnet-binaries"
    HIVE_NETWORK_TYPE: mainnet
  script:
    - echo "HOSTNAME is ${HOSTNAME} CI_CONCURRENT_ID ${CI_CONCURRENT_ID}"
    - $SCRIPTS_PATH/ci-helpers/get_image4submodule2.sh
        "$SUBMODULE_DIR" registry.gitlab.syncad.com/hive/hive/ "HIVED_IMAGE_NAME" "$REGISTRY_USER" "$REGISTRY_PASS"
        --export-binaries="$BINARY_CACHE_PATH" --network-type="$HIVE_NETWORK_TYPE"
    - ls -la ./$BINARY_CACHE_PATH/*
    - du -h -d 1 /cache

  artifacts:
    reports:
      dotenv: docker_image_name.env
    paths:
      - ./$BINARY_CACHE_PATH/*
    expire_in: 6 hours

.prepare_hived_data:
  extends: .docker_image_builder_job

  variables:
    SUBMODULE_DIR: "$CI_PROJECT_DIR"
    SCRIPTS_PATH: "$SUBMODULE_DIR/scripts"
    BLOCK_LOG_SOURCE_DIR: ""
    CONFIG_INI_SOURCE: ""
    DATA_CACHE: $DATA_CACHE_MAINNET
    HIVE_NETWORK_TYPE: mainnet
  script:
    - set -x
    - echo "HOSTNAME is ${HOSTNAME} CI_CONCURRENT_ID ${CI_CONCURRENT_ID}"
    - export COMMIT=$( $SCRIPTS_PATH/ci-helpers/retrieve_last_commit.sh ${SUBMODULE_DIR} )
    - echo "Detected that last changes afecting binary hived are at ${COMMIT}"
    - export LAST_COMMIT_DATA_CACHE=/cache/replay_data_hived_${HIVE_NETWORK_TYPE}_${COMMIT}
    - $SCRIPTS_PATH/ci-helpers/build_data2.sh --last-commit-data-cache=$LAST_COMMIT_DATA_CACHE
        --data-base-dir="$DATA_CACHE" --block-log-source-dir="$BLOCK_LOG_SOURCE_DIR" --config-ini-source="$CONFIG_INI_SOURCE"
    - du -h -d 1 /cache || true
    - cp $DATA_CACHE/datadir/docker_entrypoint.log $CI_PROJECT_DIR || true

  artifacts:
    paths:
    - docker_entrypoint.log
    expire_in: 6 hours
