<!doctype html>
<html>
<body>
  <script>

    async function my_main_function() {
      console.log('*****************BEEKEEPER TEST*****************');

      FS.unlink("/storage_root/.beekeeper/wallet_a.wallet",function(err){
        if(err) return console.log(err);
        console.log('file deleted successfully');
      });

      FS.unlink("/storage_root/.beekeeper/wallet_b.wallet",function(err){
        if(err) return console.log(err);
        console.log('file deleted successfully');
      });

      const params = new Module.StringList();
      params.push_back("--wallet-dir");
      params.push_back("/storage_root/.beekeeper");
      params.push_back("--salt");
      params.push_back("avocado");

      console.log('create beekeeper');
      var instance = new Module.beekeeper_api( params );
      console.log('beekeeper created');

      console.log('init instance');
      var init_result = instance.init();
      console.log('instance initalized with result: ' + init_result);

      console.log('create session[1]');
      var session_token = instance.create_session( "pear" )
      console.log('session[1] created with token: ' + session_token);
      session_token = JSON.parse( session_token ).token

      console.log('close session[1] with token: ' + session_token );
      instance.close_session( session_token )
      console.log('session[1] closed with token: ' + session_token);

      console.log('create session[2]');
      session_token = instance.create_session( "pear" )
      console.log('session[2] created with token: ' + session_token);
      session_token = JSON.parse( session_token ).token

      var wallet_name = "wallet_a"
      console.log('create wallet: ' + wallet_name);
      var password = instance.create( session_token, wallet_name, "cherry" )
      console.log('wallet "' + wallet_name + '" created with password: ' + password);
      password = JSON.parse( password ).password

      var wallet_name_2 = "wallet_b"
      console.log('create wallet: ' + wallet_name_2 + ' with empty password');
      var password_2 = instance.create( session_token, wallet_name_2, "" )
      console.log('wallet "' + wallet_name_2 + '" created with password: ' + password_2);
      password_2 = JSON.parse( password_2 ).password

      var private_key = "5KGKYWMXReJewfj5M29APNMqGEu173DzvHv5TeJAg9SkjUeQV78"
      console.log('import key ' + private_key + ' to wallet: "' + wallet_name_2 + '"' );
      var public_key = instance.import_key( session_token, wallet_name_2, private_key )
      console.log('public key imported: ' + public_key);

      var private_key = "5KNbAE7pLwsLbPUkz6kboVpTR24CycqSNHDG95Y8nbQqSqd6tgS"
      console.log('import key ' + private_key + ' to wallet: "' + wallet_name_2 + '"' );
      var public_key = instance.import_key( session_token, wallet_name_2, private_key )
      console.log('public key imported: ' + public_key);

      var private_key = "5JNHfZYKGaomSFvd4NUdQ9qMcEAC43kujbfjueTHpVapX1Kzq2n"
      console.log('import key ' + private_key + ' to wallet: "' + wallet_name_2 + '"' );
      var public_key = instance.import_key( session_token, wallet_name_2, private_key )
      console.log('public key imported: ' + public_key);

      var wallets = instance.list_wallets( session_token )
      console.log(wallets);

      var public_keys = instance.get_public_keys( session_token )
      console.log(public_keys);

      console.log('close wallet: ' + wallet_name_2 );
      instance.close( session_token, wallet_name_2 )

      var wallets = instance.list_wallets( session_token )
      console.log(wallets);

      console.log('open wallet: ' + wallet_name_2 );
      instance.open( session_token, wallet_name_2 )

      var wallets = instance.list_wallets( session_token )
      console.log(wallets);

      console.log('unlock wallet: ' + wallet_name_2 );
      instance.unlock( session_token, wallet_name_2, password_2 )

      var wallets = instance.list_wallets( session_token )
      console.log(wallets);

      console.log('lock wallet: ' + wallet_name_2 );
      instance.lock( session_token, wallet_name_2 )

      var wallets = instance.list_wallets( session_token )
      console.log(wallets);

      instance.lock_all( session_token )

      var wallets = instance.list_wallets( session_token )
      console.log(wallets);

      console.log('unlock wallet: ' + wallet_name_2 );
      instance.unlock( session_token, wallet_name_2, password_2 )

      console.log('remove key: ' + '7j1orEPpWp4bU2SuH46eYXuXkFKEMeJkuXkZVJSaru2zFDGaEH' + ' from wallet: ' + wallet_name_2 + ' with pass: ' + password_2)
      instance.remove_key(session_token, wallet_name_2, password_2, '7j1orEPpWp4bU2SuH46eYXuXkFKEMeJkuXkZVJSaru2zFDGaEH')

      var public_keys = instance.get_public_keys( session_token )
      console.log(public_keys);

      var info = instance.get_info( session_token )
      console.log(info);

      console.log('unlock wallet: ' + wallet_name );
      instance.unlock( session_token, wallet_name, password )

      var wallets = instance.list_wallets( session_token )
      console.log(wallets);

      var public_keys = instance.get_public_keys( session_token )
      console.log(public_keys);

      var public_key = "6LLegbAgLAy28EHrffBVuANFWcFgmqRMW13wBmTExqFE9SCkg4"
      var chain_id = "18dcf0a285365fc58b71f18b3d3fec954aa0c141c44e4e5cb4cf777b9eab274e"

      console.log('========================EXAMPLE 1========================');
      var transaction_body = '{}'
      console.log('transaction: ' + transaction_body);
      var sig_digest = "390f34297cfcb8fa4b37353431ecbab05b8dc0c9c15fb9ca1a3d510c52177542"
      console.log('************************sign digest************************');
      var signature_00 = instance.sign_digest( session_token, public_key, sig_digest )
      console.log('expected signature:')
      console.log('1f17cc07f7c769073d39fac3385220b549e261fb33c5f619c5dced7f5b0fe9c0954f2684e703710840b7ea01ad7238b8db1d8a9309d03e93de212f86de38d66f21')
      console.log('got signature:')
      console.log(signature_00)
      console.log('************************sign transaction************************');
      var signature_00 = instance.sign_transaction( session_token, transaction_body, chain_id, public_key, sig_digest )
      console.log('expected signature:')
      console.log('1f17cc07f7c769073d39fac3385220b549e261fb33c5f619c5dced7f5b0fe9c0954f2684e703710840b7ea01ad7238b8db1d8a9309d03e93de212f86de38d66f21')
      console.log('got signature:')
      console.log(signature_00)

      console.log('========================EXAMPLE 2========================');
      var transaction_body = '{"ref_block_num":95,"ref_block_prefix":4189425605,"expiration":"2023-07-18T08:38:29","operations":[{"type":"transfer_operation","value":{"from":"initminer","to":"alice","amount":{"amount":"666","precision":3,"nai":"@@000000021"},"memo":"memmm"}}],"extensions":[],"signatures":[],"transaction_id":"cc9630cdbc39da1c9b6264df3588c7bedb5762fa","block_num":0,"transaction_num":0}'
      console.log('transaction: ' + transaction_body);
      var sig_digest = "614e645c13b351b56d9742b358e3c3da58fa1a6a0036a01d3163c21aa2c8a99c"
      console.log('************************sign digest************************');
      var signature_00 = instance.sign_digest( session_token, public_key, sig_digest )
      console.log('expected signature:')
      console.log('1f69e091fc79b0e8d1812fc662f12076561f9e38ffc212b901ae90fe559f863ad266fe459a8e946cff9bbe7e56ce253bbfab0cccdde944edc1d05161c61ae86340')
      console.log('got signature:')
      console.log(signature_00)
      console.log('************************sign transaction************************');
      var signature_00 = instance.sign_transaction( session_token, transaction_body, chain_id, public_key, sig_digest )
      console.log('expected signature:')
      console.log('1f69e091fc79b0e8d1812fc662f12076561f9e38ffc212b901ae90fe559f863ad266fe459a8e946cff9bbe7e56ce253bbfab0cccdde944edc1d05161c61ae86340')
      console.log('got signature:')
      console.log(signature_00)

      console.log('set timeout [1s]');
      instance.set_timeout( session_token, 1 )

      console.log('wait 1.5s')
      await setTimeout(() => {
        console.log('after 1.5s')
        var wallets = instance.list_wallets( session_token )
        console.log(wallets);

        instance.delete();
      }, 1500)
    }

    var Module = {
      onRuntimeInitialized: function () {
        console.log('Preparing JS execution environment. ');

        FS.mkdir('/storage_root');
        FS.mount(IDBFS, {}, '/storage_root');

        /// Initialize file system before starting actual part of the APP code
        FS.syncfs(true, function (err) {
          if (err) {
            console.error("Filesystem error occured: " + err);
            return;
          }

          my_main_function();

          /// Flush the filesystem after APP execution finish
          FS.syncfs(function (err) {
            if (err)
              console.error("Filesystem error occured: " + err);
          });
        });

      },

      onExit: function () {
        console.log('Cleaning JS execution environment. ');
        FS.syncfs(function (err) {
          if (err)
            console.error("Filesystem error occured: " + err);
        });
      }
    };
  </script>
  <script src="../../../../build_wasm/beekeeper_wasm.js"></script>

  <div>Look to the console tab (developer tools)</div>
</body>
</html>
