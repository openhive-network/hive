<!doctype html>
<html>
<body>
  <script>

    function my_main_function() {
      console.log('Beekeeper test.');

      const params = new Module.StringList();
      params.push_back("--wallet-dir");
      params.push_back("/storage_root/.beekeeper-6");
      params.push_back("--salt");
      params.push_back("avocado");

      console.log('Create beekeeper...');
      var instance = new Module.beekeeper_api( params );
      console.log('Beekeeper created...');

      console.log('init instance...');
      var init_result = instance.init();
      console.log('instance initalized: ' + init_result);

      console.log('create session...');
      var session_token = instance.create_session( "pear" )
      console.log('Session created with token: ' + session_token);

      try
      {
        var wallet_name = "wallet_a"
        console.log('create wallet: ' + wallet_name);
        var password = instance.create( session_token, wallet_name, "cherry" )
        console.log('wallet "' + wallet_name + '" created with password: ' + password);
      }
      catch(error)
      {
        console.error(error)
      }

      try
      {
        var wallet_name_2 = "wallet_b"
        console.log('create wallet: ' + wallet_name_2 + ' with empty password');
        var password_2 = instance.create( session_token, wallet_name_2, "" )
        console.log('wallet "' + wallet_name_2 + '" created with password: ' + password_2);
      }
      catch(error)
      {
        console.error(error)
      }

      try
      {
        var private_key = "5KGKYWMXReJewfj5M29APNMqGEu173DzvHv5TeJAg9SkjUeQV78"
        console.log('import key ' + private_key + ' to wallet: "' + wallet_name_2 + '"' );
        var public_key = instance.import_key( session_token, wallet_name_2, private_key )
        console.log('key imported. Public key: ' + public_key);
      }
      catch(error)
      {
        console.error(error)
      }

      try
      {
        var private_key = "5KNbAE7pLwsLbPUkz6kboVpTR24CycqSNHDG95Y8nbQqSqd6tgS"
        console.log('import key ' + private_key + ' to wallet: "' + wallet_name_2 + '"' );
        var public_key = instance.import_key( session_token, wallet_name_2, private_key )
        console.log('key imported. Public key: ' + public_key);
      }
      catch(error)
      {
        console.error(error)
      }

      //instance.dump("/storage_root/.beekeeper");

      instance.delete();
      
      //var data = FS.readFile("/storage_root/instance_x-2.txt", { encoding: 'utf8' });
      //console.log("instance_x.txt file contents: " + data);
    }

    var Module = {
      onRuntimeInitialized: function () {
        console.log('Preparing JS execution environment. ');

        FS.mkdir('/storage_root');
        FS.mount(IDBFS, {}, '/storage_root');

        /// Initialize file system before starting actual part of the APP code
        FS.syncfs(true, function (err) {
          if (err) {
            console.error("Filesystem error occured: " + err);
            return;
          }

          my_main_function();

          /// Flush the filesystem after APP execution finish
          FS.syncfs(function (err) {
            if (err)
              console.error("Filesystem error occured: " + err);
          });
        });

      },

      onExit: function () {
        console.log('Cleaning JS execution environment. ');
        FS.syncfs(function (err) {
          if (err)
            console.error("Filesystem error occured: " + err);
        });
      }
    };
  </script>
  <script src="../build/beekeeper_wasm.js"></script>

  <div>Look to the console tab (developer tools)...</div>
</body>
</html>
