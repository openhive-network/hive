stages:
- test

variables:
  PYTEST_NUMBER_OF_PROCESSES: 8
  MIRRORNET_CHAIN_ID: 42
  MIRRORNET_SKELETON_KEY: "5JNHfZYKGaomSFvd4NUdQ9qMcEAC43kujbfjueTHpVapX1Kzq2n"
  GIT_DEPTH: 20
  GIT_SUBMODULE_STRATEGY: recursive
  CI_DEBUG_SERVICES: "true"
  # pin to specific docker images for build repeatability
  # uses registry.gitlab.syncad.com/hive/hive/ci-base-image:ubuntu22.04-3
  TEST_IMAGE_TAG: "@sha256:0bfb36fcb7821cb8477bc26ed4f590004904878e197a78425539dcf865193ad2"

  # Versions of Python packages
  PYTHON_JUNIT_XML_VERSION: "1.9"
  PYTHON_DATEUTIL_VERSION: "2.8.2"

  TOX_VERSION: "3.25.1"

  DATA_CACHE_HIVE: /cache/replay_data_hive
  BLOCK_LOG_SOURCE_DIR_5M: /blockchain/block_log_5m
  BLOCK_LOG_SOURCE_DIR_MIRRORNET_5M: /blockchain/block_log_5m_mirrornet

  # Variables required by Common CI jobs
  CI_COMMON_JOB_VERSION: "656cd1670240c01fe05e56ee7158ea04877da555"
  DOCKER_BUILDER_TAG: "$CI_COMMON_JOB_VERSION"
  DOCKER_DIND_TAG: "$CI_COMMON_JOB_VERSION"
  IMAGE_REMOVER_TAG: "$CI_COMMON_JOB_VERSION"

include:
  - template: Workflows/Branch-Pipelines.gitlab-ci.yml
  - local: '/scripts/ci-helpers/prepare_data_image_job.yml'
  - project: 'hive/common-ci-configuration'
    ref: 656cd1670240c01fe05e56ee7158ea04877da555
    file: '/templates/docker_image_jobs.gitlab-ci.yml'

several_node_restarts_tests:
  extends: .prepare_hived_data_5m
  image:
    name: "registry.gitlab.syncad.com/hive/common-ci-configuration/docker-builder@sha256:e0ed8144d6ad147ade7de3a6cf4d1fd809afacd063c585e4172daae24ea66ebd"
  stage: test
  variables:
    CONFIG_INI_SOURCE: "$CI_PROJECT_DIR/docker/config_5M.ini"
    HIVED_IMAGE_NAME: registry.gitlab.syncad.com/hive/hive/instance:instance-f7e1d658072ed8db9252c0b481599870442f7c90

  script:
    - ./tests/integration/test_several_node_restarts.sh
  tags:
    - public-runner-docker