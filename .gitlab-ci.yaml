stages:
- setup
- static_code_analysis
- build
- test
- publish
- deploy
- cleanup

variables:
  GIT_DEPTH: 20
  GIT_STRATEGY: clone
  GIT_SUBMODULE_STRATEGY: recursive
  CI_DEBUG_SERVICES: "true"

  # Variables required by the mirrornet pipeline
  MIRRORNET_CHAIN_ID: 42
  MIRRORNET_SKELETON_KEY: "5JNHfZYKGaomSFvd4NUdQ9qMcEAC43kujbfjueTHpVapX1Kzq2n"

  DATA_REPLAY_TAG: data-cache-storage

  # pin to specific docker images for build repeatability
  # uses registry.gitlab.syncad.com/hive/hive/ci-base-image:ubuntu22.04-10
  TEST_IMAGE_TAG: "@sha256:080b16fd53013aeb9b89b00a8dfc90fecf886173f46448b05f45cee376c43330"
  CI_COMMON_JOB_VERSION: "a3e97d90268154fae7933ea98e50e3c1c7c72d43"
  DOCKER_BUILDER_TAG: "$CI_COMMON_JOB_VERSION"
  DOCKER_DIND_TAG: "$CI_COMMON_JOB_VERSION"
  IMAGE_REMOVER_TAG: "$CI_COMMON_JOB_VERSION"
  JQ_IMAGE_TAG: "$CI_COMMON_JOB_VERSION"

  PYTEST_NUMBER_OF_PROCESSES: 8
  PYTHON_JUNIT_XML_VERSION: "1.9"
  PYTHON_DATEUTIL_VERSION: "2.8.2"
  TEST_TOOLS_VALIDATE_RESPONSE_SCHEMAS: "TRUE"

  BLOCK_LOG_SOURCE_DIR_5M: /blockchain/block_log_5m
  BLOCK_LOG_SOURCE_DIR_MIRRORNET_5M: /blockchain/block_log_5m_mirrornet

include:
  - local: scripts/ci-helpers/templates.gitlab-ci.yml

######## Templates ########

# Moved to scripts/ci-helpers/templates.gitlab-ci.yml

.wasm_beekeeper_test_base:
  extends: .job-defaults
  stage: test
  # emscripten image can be used as it contains all needed tools (node and npm).
  image: ${EMSCRIPTEN_IMAGE}
  variables:
    FF_NETWORK_PER_BUILD: 1
  before_script:
    - . "$NVM_DIR/nvm.sh"  # This loads nvm
    - nvm use "${NODEJS_VERSION}"
    - cd programs/beekeeper/beekeeper_wasm
    - pnpm install --frozen-lockfile
  tags:
    - public-runner-docker

.python_static_analysis_configuration:
  extends: .python_based
  needs: []  # to run immediately without waiting for previous jobs
  variables:
    PACKAGES_TO_CHECK: "$CI_PROJECT_DIR/tests/python/"
    PYPROJECT_CONFIG_PATH: "$CI_PROJECT_DIR/tests/python/hive-local-tools/pyproject.toml"
  before_script:
    - !reference [.python_based, before_script]
    - cd $CI_PROJECT_DIR/tests/python/hive-local-tools
  tags:
    - public-runner-docker

.test_tools_based:
  extends: .test_tools_based_base
  needs:
    - job: testnet_node_build
      artifacts: true

.beem_tests_base:
  stage: test
  extends: .test_tools_based
  script:
    - git clone --depth=1 --single-branch --branch master https://gitlab.syncad.com/hive/beem.git
    - pip3 install junit-xml==${PYTHON_JUNIT_XML_VERSION} python-dateutil==${PYTHON_DATEUTIL_VERSION}
    - cd beem
    - python3 -m pip install .[tests]
    - python3 setup.py install
    - cd ..
    - mkdir -p build/tests/hive-node-data
    - cd tests/python/functional/beem_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

.fork_test_base:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 20
    PYTEST_NUMBER_OF_PROCESSES: 3
  script:
    - cd tests/python/functional/fork_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker
  artifacts:
    expire_in: 2 days

.unit_tests_base:
  extends: .job-defaults
  stage: test
  needs:
    - job: testnet_node_build
      artifacts: true
  image: "$CI_REGISTRY_IMAGE/ci-base-image$TEST_IMAGE_TAG"
  variables:
    GIT_STRATEGY: none
    FF_NETWORK_PER_BUILD: "true"
  tags:
    - public-runner-docker

######## End templates ########

######## Setup ########

environment-debug-job:
  stage: setup
  image: "$CI_REGISTRY_IMAGE/ci-base-image$TEST_IMAGE_TAG"
  script:
    - |
      echo "Current environment:"
      set
  tags:
    - public-runner-docker

determine-runner-tag:
  extends: .determine-runner-tag-template
  stage: setup

######## End setup ########

######## Static code analysis ########

verify_poetry_lock_sanity:
  extends: .verify_poetry_lock_sanity_template
  stage: static_code_analysis
  variables:
    PYPROJECT_DIR: "$CI_PROJECT_DIR/tests/python/hive-local-tools"
  tags:
    - public-runner-docker

pre_commit_checks:
  stage: static_code_analysis
  extends:
    - .pre_commit_checks_template
    - .python_static_analysis_configuration
  artifacts:
    paths:
      - tests/python/hive-local-tools/poetry.lock

lint_code_with_ruff:
  stage: static_code_analysis
  extends:
    - .lint_code_with_ruff_template
    - .python_static_analysis_configuration

formatting_with_black_check:
  stage: static_code_analysis
  extends:
    - .formatting_with_black_check_template
    - .python_static_analysis_configuration

######## End static code analysis ########

######## Build ########

prepare_hived_image:
  extends: .prepare_hived_image
  stage: build
  variables:
    REGISTRY_USER: "$HIVED_CI_IMGBUILDER_USER"
    REGISTRY_PASS: $HIVED_CI_IMGBUILDER_PASSWORD
    BINARY_CACHE_PATH: "$CI_PROJECT_DIR/hived-binaries"
    HIVE_NETWORK_TYPE: mainnet
  tags:
    - public-runner-docker
    - hived-for-tests

prepare_hived_image_dotenv:
  extends: .rewrite-dotenv-and-extract-binaries
  stage: build
  variables:
    DOT_ENV_FILENAME: "mainnet_dotenv"
    DOTENV_VAR_PREFIX: "MAINNET_HIVED"
    DOTENV_VAR_NAME: "HIVED"
  needs:
    - job: prepare_hived_image

testnet_node_build:
  extends: .prepare_hived_image
  stage: build
  variables:
    REGISTRY_USER: "$HIVED_CI_IMGBUILDER_USER"
    REGISTRY_PASS: $HIVED_CI_IMGBUILDER_PASSWORD
    BINARY_CACHE_PATH: "$CI_PROJECT_DIR/hived-testnet-binaries"
    HIVE_NETWORK_TYPE: testnet
  artifacts:
    paths:
      - "$BINARY_CACHE_PATH"
  tags:
    - public-runner-docker
    - hived-for-tests

prepare_testnet_hived_image_dotenv:
  extends: .rewrite-dotenv-and-extract-binaries
  stage: build
  variables:
    DOT_ENV_FILENAME: "testnet_dotenv"
    DOTENV_VAR_PREFIX: "TESTNET_HIVED"
    DOTENV_VAR_NAME: "HIVED"
  needs:
    - job: testnet_node_build

mirrornet_node_build:
  stage: build
  extends: .prepare_hived_image
  variables:
    REGISTRY_USER: "$HIVED_CI_IMGBUILDER_USER"
    REGISTRY_PASS: $HIVED_CI_IMGBUILDER_PASSWORD
    BINARY_CACHE_PATH: "$CI_PROJECT_DIR/hived-mirrornet-binaries"
    HIVE_NETWORK_TYPE: mirrornet
  after_script:
    - |
      source docker_image_name.env
      echo "Pushing hived image for commits on develop, master and tagged"
      docker images
      IMAGE_NAME_PREFIX="$CI_REGISTRY_IMAGE/mirrornet-instance:"
      if [[ "$CI_COMMIT_BRANCH" == "develop" ]];
      then
        docker tag $HIVED_IMAGE_NAME_INSTANCE ${IMAGE_NAME_PREFIX}latest
        docker push ${IMAGE_NAME_PREFIX}latest
      elif [[ "$CI_COMMIT_BRANCH" == "master" ]];
      then
        docker tag $HIVED_IMAGE_NAME_INSTANCE ${IMAGE_NAME_PREFIX}stable
        docker push ${IMAGE_NAME_PREFIX}stable
      elif [[ -n "$CI_COMMIT_TAG" ]];
      then
        docker tag $HIVED_IMAGE_NAME_INSTANCE ${IMAGE_NAME_PREFIX}${CI_COMMIT_TAG}
        docker push ${IMAGE_NAME_PREFIX}${CI_COMMIT_TAG}
      fi

  tags:
    - public-runner-docker
    - hived-for-tests

dynamic-tag-pipeline-trigger:
  extends: .dynamic-tag-pipeline-trigger-template
  stage: build
  needs:
    - job: determine-runner-tag
    - job: prepare_hived_image_dotenv
    - job: prepare_testnet_hived_image_dotenv
  trigger:
    strategy: depend
    forward:
      yaml_variables: true
      pipeline_variables: true
    include:
      - local: scripts/ci-helpers/dynamic-tag-pipeline.gitlab-ci.yml

beekeeper_wasm_build:
  extends: .wasm_build_job_template
  stage: build
  variables:
    SOURCE_DIR: "${CI_PROJECT_DIR}/programs/beekeeper/beekeeper_wasm/"
    BINARIES_DIR: "${CI_PROJECT_DIR}/programs/beekeeper/beekeeper_wasm/build"
  tags:
    - public-runner-docker

beekeeper_tsc_build:
  extends: .npm_build_template
  stage: build
  variables:
    SOURCE_DIR: "${CI_PROJECT_DIR}/programs/beekeeper/beekeeper_wasm"
    DIST_DIR: "${CI_PROJECT_DIR}/programs/beekeeper/beekeeper_wasm/dist"
    NPM_PACKAGE_SCOPE: "@hiveio"
    NPM_PACKAGE_NAME: "beekeeper"
  needs:
    - job: beekeeper_wasm_build
      artifacts: true
  tags:
    - public-runner-docker

######## End build ########

######## Test ########

dynamic-pipeline-details-collector:
  extends: .dynamic-pipeline-details-collector-template
  stage: test
  needs:
    - job: dynamic-tag-pipeline-trigger
  tags:
    - public-runner-docker

dynamic-pipeline-test-results-collector:
  extends: .dynamic-pipeline-test-results-collector-template
  stage: test
  needs:
    - job: dynamic-pipeline-details-collector
  parallel:
    matrix:
      - CHILD_PIPELINE_JOB: [ "patterns_tests",
                              "python_pattern_mainnet_tests",
                              "message_format_mainnet_5m_tests: [wallet_bridge_api_tests]",
                              "message_format_mainnet_5m_tests: [transaction_status_api_tests]",
                              "message_format_mainnet_5m_tests: [reputation_api_tests]",
                              "message_format_mainnet_5m_tests: [rc_api_tests]",
                              "message_format_mainnet_5m_tests: [market_history_api_tests]",
                              "message_format_mainnet_5m_tests: [json_rpc_api_tests]",
                              "message_format_mainnet_5m_tests: [database_api_tests]",
                              "message_format_mainnet_5m_tests: [condenser_api_tests]",
                              "message_format_mainnet_5m_tests: [block_api_tests]",
                              "message_format_mainnet_5m_tests: [account_history_api]",
                              "message_format_mainnet_5m_tests: [account_by_key_api_tests]",
                              "witness_tests" ]
  tags:
    - public-runner-docker

test_beekeeper_wasm:
  extends: .npm_test_template
  needs:
    - job: beekeeper_wasm_build
      artifacts: true
    - job: beekeeper_tsc_build
      artifacts: true
  variables:
    SOURCE_DIR: "programs/beekeeper/beekeeper_wasm"
    PACKAGE_TGZ_PATH: "${BUILT_PACKAGE_PATH}"
  tags:
    - public-runner-docker  

artifacts_generation_tests:
  extends: .job-defaults
  stage: test
  image: "$CI_REGISTRY_IMAGE/ci-base-image$TEST_IMAGE_TAG"
  needs:
    - job: prepare_hived_image
      artifacts: true
  variables:
    BINARY_CACHE_PATH: "$CI_PROJECT_DIR/hived-binaries"
  script:
    - cd tests/integration/artifacts_generation
    - ./test_artifacts_generation.sh "$BINARY_CACHE_PATH/hived" "$BINARY_CACHE_PATH/block_log_util"
  tags:
    - public-runner-docker

several_node_restarts_tests:
  extends: .prepare_hived_data_5m
  stage: test
  needs:
    - job: prepare_hived_image
      artifacts: true
  variables:
    BLOCK_LOG_SOURCE_DIR: "$BLOCK_LOG_SOURCE_DIR_5M"
    CONFIG_INI_SOURCE: "$CI_PROJECT_DIR/docker/config_5M.ini"
  script:
    - test -n "$HIVED_IMAGE_NAME"
    - ./tests/integration/test_several_node_restarts.sh $CI_PROJECT_DIR/data_generated_during_hive_replay 1000000 1500000
  artifacts:
    reports:
      dotenv:
        - docker_image_name.env
    paths:
      - $CI_PROJECT_DIR/data_generated_during_hive_replay/datadir/docker_entrypoint.log
  tags:
    - public-runner-docker

mirrornet_replay_test:
  extends: .job-defaults
  stage: test
  image: "$CI_REGISTRY_IMAGE/ci-base-image$TEST_IMAGE_TAG"
  needs:
    - job: "mirrornet_node_build"
      artifacts: true

  variables:
    BINARIES_DIR: "hived-mirrornet-binaries"
    BLOCK_LOG_SOURCE_DIR: "/blockchain"
    NUMBER_OF_BLOCKS: 5000000
    MIRRORNET_WORKING_DIR: "$CI_PROJECT_DIR/mirrornet"
    MIRRORNET_BLOCKCHAIN_DATA_DIR: "$MIRRORNET_WORKING_DIR/mirrornet_blockchain_data"
    MIRRORNET_SOURCE_5M_DATA_DIR: "$MIRRORNET_WORKING_DIR/source_5m"
    MAINNET_TRUNCATED_DIR: "$CI_PROJECT_DIR/mainnet"
    CONFIG_INI_SOURCE: "$CI_PROJECT_DIR/docker/config_mirrornet_5M.ini"
  before_script:
    - export NUMBER_OF_PROCESSES=8
    - mkdir -p "$MAINNET_TRUNCATED_DIR"
    - mkdir -p "$MIRRORNET_SOURCE_5M_DATA_DIR"
    - mkdir -p "$MIRRORNET_SOURCE_5M_DATA_DIR/blockchain"
    - mkdir -p "$MIRRORNET_BLOCKCHAIN_DATA_DIR"
    - mkdir -p "$MIRRORNET_BLOCKCHAIN_DATA_DIR/blockchain"
    - cp "$CI_PROJECT_DIR/docker/config_mirrornet_5M.ini" "$MIRRORNET_WORKING_DIR/config.ini"
    - cp "$BLOCK_LOG_SOURCE_DIR/block_log_5m/block_log" "$MIRRORNET_SOURCE_5M_DATA_DIR/blockchain"
    - cd "$BINARIES_DIR"
  script:
    - echo "Generating artifacts file for block_log."
    - time ./hived
      -d "$MIRRORNET_SOURCE_5M_DATA_DIR"
    - echo "Compressing block log to $NUMBER_OF_BLOCKS blocks with $NUMBER_OF_PROCESSES processes"
    - time ./compress_block_log
      -i "$MIRRORNET_SOURCE_5M_DATA_DIR/blockchain/block_log"
      -o "$MAINNET_TRUNCATED_DIR/block_log"
      --decompress
      -n $NUMBER_OF_BLOCKS
      --jobs $NUMBER_OF_PROCESSES
    - echo "Converting block log to mirrornet format with $NUMBER_OF_PROCESSES processes"
    - time ./blockchain_converter
      --plugin block_log_conversion
      -i "$MAINNET_TRUNCATED_DIR/block_log"
      -o "$MIRRORNET_BLOCKCHAIN_DATA_DIR/blockchain/block_log"
      --chain-id $MIRRORNET_CHAIN_ID
      --private-key "$MIRRORNET_SKELETON_KEY"
      --use-same-key
      --jobs $NUMBER_OF_PROCESSES
    - echo "Starting hived replay"
    - ./hived
      -d "$MIRRORNET_BLOCKCHAIN_DATA_DIR"
      --chain-id $MIRRORNET_CHAIN_ID
      --skeleton-key "$MIRRORNET_SKELETON_KEY"
      --set-benchmark-interval 100000
      --force-replay
      --validate-during-replay
      --stop-replay-at-block $NUMBER_OF_BLOCKS
      --exit-before-sync | tee hived-replay.log
  artifacts:
    paths:
      - "$BINARIES_DIR/*.log"
  tags:
    - public-runner-docker
    - hived-for-tests

beem_testnet_tests:
  extends: .beem_tests_base
  needs:
    - job: testnet_node_build
      artifacts: true
  variables:
    PYTEST_TIMEOUT_MINUTES: 18
    PYTEST_ARGS: "-m not mirrornet"
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/beem_tests/report.xml

beem_mirrornet_tests:
  extends: .beem_tests_base
  needs:
    - job: mirrornet_node_build
      artifacts: true
  variables:
    PYTEST_TIMEOUT_MINUTES: 4
    HIVED_PATH: "$CI_PROJECT_DIR/hived-mirrornet-binaries/hived"
    CLI_WALLET_PATH: "$CI_PROJECT_DIR/hived-mirrornet-binaries/cli_wallet"
    GET_DEV_KEY_PATH: "$CI_PROJECT_DIR/hived-mirrornet-binaries/get_dev_key"
    BLOCK_LOG_UTIL_PATH: "$CI_PROJECT_DIR/hived-mirrornet-binaries/block_log_util"
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/beem_tests/report.xml
  before_script:
    - !reference [.beem_tests_base, before_script]
    - export PYTEST_ARGS=(-m mirrornet --chain-id ${MIRRORNET_CHAIN_ID} --skeleton-key "${MIRRORNET_SKELETON_KEY}")

chain_test:
  extends: .unit_tests_base
  script:
    - timeout 23m ./hived-testnet-binaries/chain_test --log_format=JUNIT --log_sink=chain_test_results.xml --log_level=error > chain_test.log 2>&1
  artifacts:
    reports:
      junit: chain_test_results.xml
    paths:
      - chain_test.log
    when: always
    expire_in: 1 week

plugin_test:
  extends: .unit_tests_base
  script:
    # note: consider using --result_code=no to force exit code 0 even when tests fail because they currently fail and I want a nice green checkmark
    - timeout 6m ./hived-testnet-binaries/plugin_test --log_format=JUNIT --log_sink=plugin_test_results.xml --log_level=error > plugin_test.log 2>&1
  artifacts:
    reports:
      junit: plugin_test_results.xml
    paths:
      - plugin_test.log
    when: always
    expire_in: 1 week

cli_wallet_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/cli_wallet/report.xml
    PYTEST_TIMEOUT_MINUTES: 30
  script:
    - cd tests/python/functional/cli_wallet
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

hived_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/hived/report.xml
    PYTEST_TIMEOUT_MINUTES: 30
  script:
    - cd tests/python/functional/hived
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

cli_wallet_extended_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 14
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/cli_wallet_extended_tests/report.xml
  script:
    - cd tests/python/functional/cli_wallet_extended_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

live_sync_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 10
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/live_sync_tests/report.xml
  script:
    - cd tests/python/functional/live_sync_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

broadcast_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 6
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/broadcast_tests/report.xml
  script:
    - cd tests/python/functional/broadcast_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

test_tools_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 30
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/hive-local-tools/test-tools/tests/report.xml
  script:
    - cd tests/python/hive-local-tools/test-tools/tests
    - pip install local-tools/
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

rc_direct_delegations_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 12
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/direct_rc_delegations_tests/report.xml

  script:
    - cd tests/python/functional/direct_rc_delegations_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

message_format_testnet_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 25
    SIGN_TRANSACTION_PATH: "$CI_PROJECT_DIR/hived-testnet-binaries/sign_transaction"
    NODE_TYPE: "testnet"
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/api_tests/message_format_tests/$API/report.xml
  script:
    - cd tests/python/api_tests/message_format_tests/$API
    - export PYTEST_ARGS=(-m "${NODE_TYPE} or (not testnet and not mainnet_5m and not live_mainnet)")
    - !reference [.run-pytest, script]
  parallel:
    matrix:
      - API: [ account_by_key_api_tests,
               account_history_api,
               block_api_tests,
               condenser_api_tests,
               database_api_tests,
               debug_node_api_tests,
               json_rpc_api_tests,
               market_history_api_tests,
               network_broadcast_api_tests,
               rc_api_tests,
               reputation_api_tests,
               transaction_status_api_tests,
               wallet_bridge_api_tests ]
  tags:
    - public-runner-docker

datagen_api_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 25
    SIGN_TRANSACTION_PATH: "$CI_PROJECT_DIR/hived-testnet-binaries/sign_transaction"
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/datagen_tests/report.xml
  script:
    - cd tests/python/functional/datagen_tests/
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

transaction_serialization_testnet_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 15
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/transaction_serialization_tests/report.xml

  script:
    - cd $CI_PROJECT_DIR/tests/python/functional/transaction_serialization_tests
    - export PYTEST_ARGS=(-m testnet)
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

python_pattern_testnet_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 10
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/api_tests/python_patterns_tests/report.xml
  script:
    - cd tests/python/api_tests/python_patterns_tests/
    - export PYTEST_ARGS=(-m "not testnet and not mainnet_5m and not live_mainnet")
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

foundation_layer_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 6
  script:
    - cd tests/python/functional/foundation_layer_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

hf26_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 20
    SIGN_TRANSACTION_PATH: "$CI_PROJECT_DIR/hived-testnet-binaries/sign_transaction"
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/hf26_tests/report.xml
  script:
    - cd tests/python/functional/hf26_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

hf28_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 20
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/hf28_tests/report.xml
  script:
    - cd tests/python/functional/hf28_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

functional_api_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 3
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/api_tests/report.xml
  script:
    - cd tests/python/functional/api_tests/
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker
    - hived-for-tests

hardfork_schedule_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 3
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/hardfork_schedule_tests/report.xml
  script:
    - cd tests/python/functional/hardfork_schedule_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

recovery_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 10
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/recovery_tests/report.xml
  script:
    - cd tests/python/functional/recovery_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

operation_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_TIMEOUT_MINUTES: 15
    SERIALIZE_SET_PROPERTIES_PATH: "$CI_PROJECT_DIR/hived-testnet-binaries/serialize_set_properties"
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/operation_tests/report.xml
  script:
    - cd tests/python/functional/operation_tests/$OPERATION
    - !reference [.run-pytest, script]
  parallel:
    matrix:
      - OPERATION: [ account_update_tests,
                     account_witness_proxy_tests,
                     account_witness_vote_tests,
                     cancel_transfer_from_savings,
                     comment_tests,
                     convert_tests,
                     custom_and_custom_json_tests,
                     escrow_tests,
                     limit_order_tests,
                     proposal_tests,
                     set_withdraw_vesting_route_tests,
                     test_recurrent_transfer,
                     test_transfer_to_vesting_operation,
                     test_withdraw_vesting_operation,
                     transfer_from_savings_tests,
                     transfer_tests,
                     transfer_to_savings_tests,
                     update_proposal_votes_tests,
                     witness_ops_tests ]
  tags:
    - public-runner-docker

comment_cashout_tests:
  stage: test
  extends: .test_tools_based
  variables:
    PYTEST_NUMBER_OF_PROCESSES: 1
    PYTEST_TIMEOUT_MINUTES: 30
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/comment_cashout_tests/report.xml
  script:
    - cd tests/python/functional/comment_cashout_tests
    - !reference [.run-pytest, script]
  tags:
    - public-runner-docker

fork_tests_1_of_3:
  extends: .fork_test_base
  variables:
    PYTEST_ARGS: "-m fork_tests_group_1"
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/fork_tests/report_group_1.xml

fork_tests_2_of_3:
  extends: .fork_test_base
  variables:
    PYTEST_ARGS: "-m fork_tests_group_2"
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/fork_tests/report_group_2.xml

fork_tests_3_of_3:
  extends: .fork_test_base
  variables:
    PYTEST_ARGS: "-m fork_tests_group_3"
    PYTEST_JUNIT_REPORT: $CI_PROJECT_DIR/tests/python/functional/fork_tests/report_group_3.xml

message_format_live_mainnet_tests:
  extends: .message_format_tests
  needs:
    - job: testnet_node_build
      artifacts: true
  variables:
    NODE_ADDRESS: "http://api.fqdn.pl:8092"
    NODE_TYPE: "live_mainnet"
  rules:
    # Run this job, only when environment variable "RUN_MESSAGE_FORMAT_TESTS_ON_LIVE_MAINNET" is set
    - if: $RUN_MESSAGE_FORMAT_TESTS_ON_LIVE_MAINNET == "TRUE"
      when: always

######## End test ########

######## Publish ########

deploy_beekeeper_wasm_dev_package:
  extends: .npm_deploy_package_template
  stage: publish
  variables:
    SOURCE_DIR: "programs/beekeeper/beekeeper_wasm"
    PACKAGE_TGZ_PATH: "${BUILT_PACKAGE_PATH}"
    NPM_PACKAGE_SCOPE: "@hiveio"
  needs:
    - job: test_beekeeper_wasm
    - job: beekeeper_wasm_build
      artifacts: true
    - job: beekeeper_tsc_build
      artifacts: true
  tags:
    - public-runner-docker

deploy_beekeeper_wasm_production_public_npm:
  extends: .registry_npmjs_org_deploy_package_template
  stage: publish
  variables:
    NPM_PUBLISH_TOKEN: "$INTERNAL_HIDDEN_PUBLISH_TOKEN"
    NPM_PACKAGE_NAME: "beekeeper"
    PACKAGE_TGZ_PATH: "${BUILT_PACKAGE_PATH}"
  needs:
    - job: test_beekeeper_wasm
    - job: beekeeper_wasm_build
      artifacts: true
    - job: beekeeper_tsc_build
      artifacts: true
  tags:
    - public-runner-docker

publish_docker_image:
  stage: publish
  extends: .publish_docker_image_template
  before_script:
    - !reference [.publish_docker_image_template, before_script]
  script:
    - scripts/ci-helpers/build_and_publish_instance.sh
  tags:
    - public-runner-docker
    - hived-for-tests

######## End publish ########

######## Deploy ########

full-mirrornet-conversion-trigger:
  stage: deploy
  variables:
    # This job will need just a Hive source code (access to some configuration files and scripts)
    GIT_STRATEGY: "clone"
    GIT_SUBMODULE_STRATEGY: "none"
  rules:
    # Create a child pipeline only when master/develop are a target branches. Child pipeline definition has defined manual job, so it will not start automatically.
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == "develop")
  trigger:
    forward:
      yaml_variables: true
      pipeline_variables: true
    include:
      - local: scripts/ci-helpers/full-mirrornet-conversion.gitlab-ci.yml

######## End deploy ########

######## Cleanup ########

cleanup_cache_on_hived_builders:
  extends: .cleanup_cache_manual_template
  stage: cleanup
  variables:
    CLEANUP_PATH_PATTERN: "/cache/replay_data_hive_*"
  tags:
    - public-runner-docker
    - hived-for-tests

######## End cleanup ########